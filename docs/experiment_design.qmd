# 実験概要

## 1. 実験の全体目標

学生は2回の実験（各180分）を通して、多層的な内部ネットワークの構築、静的ルーティング、DNSによる名前解決、そしてNAPTによるインターネット接続までを実践的に体験し、その仕組みを深く理解することを目標とする。

## 2. ネットワーク構成

実験で構築するネットワークの全体像は以下の通りである。

![ネットワーク構成図](../images/new_network_diagram.png){ width=40% }

### 2.1. 構成要素

*   **インターネット領域（教員準備）:**
    *   **外部DNSサーバー (`ExtDNS`):** `example.com` などのドメイン情報を持つDNSサーバー。
    *   **外部Webサーバー (`ExtWeb`):** インターネット上にあるWebサイトの役割を担うサーバー。
*   **学生構築ネットワーク:**
    *   **ゲートウェイ (`GW`):** 組織全体の出入り口。WAN側とLAN側を持ち、NAPT機能で内部ネットワークをインターネットに接続する。
    *   **トランジットセグメント:** GWと内部ルーターを接続する中継ネットワーク。
    *   **内部DNSサーバー (`IntDNS`):** `corp.local` のような内部ドメインの名前解決を担う。
    *   **内部Webサーバー (`IntWeb`):** 組織内でのみアクセス可能なWebサーバー。
    *   **ルーター1 (`R1`) / ルーター2 (`R2`):** 内部ネットワークをさらにセグメントに分割する。
    *   **クライアントPC A/B:** 各セグメントに属する端末。

### 2.2. IPアドレッシング計画

| 機器名 | 役割 | インターフェース | IPアドレス | サブネットマスク | ゲートウェイ | DNSサーバー |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **インターネット領域** | | | | | |
| ExtDNS | 外部DNS | - | `10.0.0.53` | `255.255.255.0` | `10.0.0.254` | (自身) |
| ExtWeb | 外部Web | - | `10.0.0.80` | `255.255.255.0` | `10.0.0.254` | `10.0.0.53` |
| **学生構築ネットワーク** | | | | | |
| GW | ゲートウェイ | WAN (eth0) | `10.0.0.1` | `255.255.255.0` | `10.0.0.254` | `10.0.0.53` |
| | | LAN (eth1) | `192.168.0.1` | `255.255.255.0` | - | - |
| IntDNS | 内部DNS | eth0 | `192.168.0.53` | `255.255.255.0` | `192.168.0.1` | (自身), `10.0.0.53` |
| IntWeb | 内部Web | eth0 | `192.168.0.80` | `255.255.255.0` | `192.168.0.1` | `192.168.0.53` |
| R1 | ルーター1 | WAN (eth0) | `192.168.0.11` | `255.255.255.0` | `192.168.0.1` | - |
| | | LAN (eth1) | `192.168.1.1` | `255.255.255.0` | - | - |
| R2 | ルーター2 | WAN (eth0) | `192.168.0.12` | `255.255.255.0` | `192.168.0.1` | - |
| | | LAN (eth1) | `192.168.2.1` | `255.255.255.0` | - | - |
| ClientA | クライアントA | eth0 | `192.168.1.10` | `255.255.255.0` | `192.168.1.1` | `192.168.0.53` |
| ClientB | クライアントB | eth0 | `192.168.2.10` | `255.255.255.0` | `192.168.2.1` | `192.168.0.53` |

## 3. 各回の実験テーマ

### 第1回：内部ネットワークの構築と静的ルーティング

*   **目標:** ゲートウェイ、内部サーバー、ルーター、クライアントPCを接続し、静的ルーティングによって内部ネットワーク全体の通信を確立する。
*   **内容:**
    1.  各PC/サーバーへのIPアドレス設定。
    2.  ルーター1およびルーター2でIPフォワーディングを有効化する。
    3.  クライアントPC A/Bにデフォルトゲートウェイを設定する。
    4.  ゲートウェイ(`GW`)に内部ネットワーク(`192.168.1.0/24`, `192.168.2.0/24`)への静的ルートを設定する。
    5.  `ping` と `traceroute` を用いて ClientA <=> ClientB, ClientA <=> IntWeb などの通信を確認し、パケットの経路を追跡する。
    6.  内部DNSサーバーを構築し、`intweb.corp.local` のような内部ドメインの名前解決ができることを確認する。

### 第2回：NAPTによるインターネット接続

*   **目標:** ゲートウェイにNAPT（IPマスカレード）を設定し、内部ネットワークからインターネット上のサーバーへアクセスできるようにする。
*   **内容:**
    1.  ゲートウェイ(`GW`)で `iptables` を用いてNAPT（IPマスカレード）を設定する。
    2.  クライアントPC Aから外部Webサーバー(`10.0.0.80`)へ `ping` が通ることを確認する。
    3.  外部DNSサーバー(`10.0.0.53`)を利用して `www.example.com` のような外部ドメインの名前解決ができることを確認する。
    4.  クライアントPC Aのブラウザから外部Webサーバーにアクセスする。
    5.  ゲートウェイで `conntrack` コマンドや `iptables` のカウンタを確認し、NAPTによるアドレス変換の様子を観察する。

## 4. レポート課題

*   **考察事項**
    *   問1: ClientAからClientBへ `ping` を送信した際、パケットはどのような経路を辿るか。`traceroute` の結果を基に、各ルーターのルーティングテーブルがどのように利用されるかを説明せよ。
    *   問2: ゲートウェイ(`GW`)に内部ネットワーク(`192.168.1.0/24`, `192.168.2.0/24`)への静的ルートを設定しない場合、内部WebサーバーからClientAへの通信はなぜ失敗するのか説明せよ。
    *   問3: NAPTの役割とは何か。内部ネットワークのPCが1つのグローバルIPアドレス(`10.0.0.1`)を使ってインターネットと通信できる仕組みを、実験結果を交えて説明せよ。
    *   問4: 内部DNSと外部DNSの役割の違いは何か。ClientAが `intweb.corp.local` と `www.example.com` の両方にアクセスできるのはなぜか、名前解決のプロセスを追って説明せよ。

